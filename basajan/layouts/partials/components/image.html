{{ $original := resources.Get .src }}

{{ if not $original }}
	{{ with .context }}
		{{ $original = .Resources.GetMatch $.src }}
	{{ end }}
{{ end }}

{{ if not $original }}
	{{ $original = resources.GetRemote .src }}
{{ end }}

{{ $mediaTypes := newScratch }}
{{ $mediaTypes.Add "webp" "image/webp" }}
{{ $mediaTypes.Add "jpeg" "image/jpeg" }}
{{ $mediaTypes.Add "jpg" "image/jpeg" }}
{{ $mediaTypes.Add "png" "image/png" }}

{{ $formats := slice "webp" "png" "jpg" "jpeg" }}
{{ $sizes := slice 240 320 360 480 640 }}

{{ with .limit }}
	{{ $original = $original.Resize (print . "x") }}
{{ end }}

{{ $sourceFormat := strings.TrimPrefix "." (path.Ext $original) }}

<picture>
	{{ if in $formats $sourceFormat }}
		{{ $formats = slice "webp" | append $sourceFormat }}

		{{ range $format := $formats }}
			{{ $optimized := slice }}

			{{ range $size := $sizes }}
				{{ if le $size $original.Width }}
					{{ $optimized = $optimized | append (print ($original.Resize (print $size "x" " " $format)).RelPermalink " " $size "w") }}
				{{ end }}
			{{ end }}

			{{ $optimized = $optimized | append (print ($original.Resize (print $original.Width "x" " " $format)).RelPermalink " " $original.Width "w") }}

			<source
				sizes="(min-width: 640px) 50vw, 100vw"
				srcset="{{ delimit $optimized ", " }}"
				type="{{ $mediaTypes.Get $format }}"
			/>
		{{ end }}
	{{ end }}

	<img
		src="{{ $original.RelPermalink | safeURL }}"
		alt="{{ .alt }}"
		width="{{ $original.Width }}"
		height="{{ $original.Height }}"
		loading="lazy"
		decoding="async"
		{{ with .class }}class="{{ . }}"{{ end }}
	/>
</picture>
